@startuml
!theme plain

actor Commercial
participant "API Backend" as API
participant "Base de Données" as DB
participant "Fonctions Validation" as ValidationFuncs
participant "Fonctions Génération" as GenerationFuncs
participant "Fonctions TVA" as TaxFuncs
participant "Procédures Stockées" as Procedures
participant "Odoo" as Odoo

Commercial-->API: POST /api/invoices/generate-from-quote/{quote_id}
API-->DB: SELECT can_create_invoice_from_quote(:quote_id)
DB-->ValidationFuncs: can_create_invoice_from_quote()
ValidationFuncs-->ValidationFuncs: can_generate_invoice()
ValidationFuncs--->DB: TRUE
DB--->API: Validation OK
API-->DB: CALL sp_generate_invoice_from_quote(:quote_id, @invoice_id)
DB-->GenerationFuncs: generate_invoice_number()
GenerationFuncs--->DB: "FAC-2025-0001"
DB-->DB: SELECT get_quote_total(quote_id)
DB-->TaxFuncs: calculate_tax_amount(total_ht, 20.00)
TaxFuncs--->DB: Montant TVA
DB-->DB: INSERT INTO invoices (...)
DB-->DB: INSERT INTO invoice_lines FROM quote_lines
DB--->API: Invoice créé (invoice_id)
API-->Odoo: Créer facture Odoo
Odoo--->API: Invoice Odoo créée
API-->DB: UPDATE travels SET odoo_invoice_id = ...
DB--->API: Mis à jour
API--->Commercial: 201 Created (invoice)

@enduml